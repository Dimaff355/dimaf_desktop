# P2P Приложение Удаленного Рабочего Стола (Windows)

Этот репозиторий содержит исходный код для peer-to-peer (P2P) системы удаленного управления, концептуально похожей на TeamViewer или RustDesk. Приложение предназначено для Windows и находится в стадии **технического прототипа (MVP)**.

> Текущая версия является "Proof of Concept". Она демонстрирует установку соединения, передачу изображения и ввод, но не готова для коммерческого использования (отсутствует сжатие видеопотока, нет полноценной архитектуры для работы в режиме системной службы).

## Ограничения MVP
- **Только видео и управление:** Звук не передается.
- **Нет передачи файлов:** Нет общего буфера обмена, чата или передачи файлов.
- **Одна активная сессия:** Поддерживается только один оператор одновременно.
- **Производительность:** Видео передается как последовательность PNG-кадров через Data Channel, что обеспечивает совместимость, но дает низкий FPS по сравнению с полноценным видеокодеком.

## Технологический стек
- **Язык:** C# (.NET 8).
- **Архитектура:** Хост (Консольное приложение/Служба) + Клиент (Operator Console/GUI) + Сигнальный сервер.
- **Сеть:** WebRTC (библиотека SIPSorcery) + WebSocket для сигнализации.
- **Кодеки:** Передача кадров через WebRTC Data Channel (PNG).

## Архитектура системы

### 1. Signaling Server (Сигнальный сервер)
- Легковесный WebSocket-сервер.
- Соединяет Хоста и Оператора для обмена SDP (настройками соединения) и ICE-кандидатами (обход NAT).
- Не передает само видео, только служебные данные для установки прямого соединения.

### 2. Host Side (Сторона хоста)
- **Core Service:** Основное приложение. В текущей версии для корректного захвата экрана его рекомендуется запускать как **консольное приложение** в сессии пользователя (для обхода изоляции Session 0 и черного экрана).
- **Функции:** Захват экрана (DXGI Desktop Duplication с фоллбэком на GDI), инъекция ввода (мышь/клавиатура), обработка WebRTC.
- **Configurator:** GUI-утилита (WPF) для настройки пароля, адреса резолвера и ICE-серверов через именованные каналы (Named Pipes).

### 3. Client Side (Сторона оператора)
 - **Operator Console:** Графическое WPF-приложение, которое отображает видео поток в реальном времени, обрабатывает ввод с мыши и клавиатуры оператора и отправляет команды хосту. Также позволяет переключать мониторы и отправлять комбинацию Ctrl+Alt+Del.

## Запуск и использование (Для разработчиков)

Для запуска требуется .NET 8 SDK.

### Шаг 1: Запуск сигнального сервера
Запустите локальный ретранслятор (по умолчанию порт 5000):
```bash
dotnet run --project src/SignalingServer --urls=http://localhost:5000
```

Проверка работоспособности: откройте в браузере `http://localhost:5000/health`

### Шаг 2: Настройка и запуск Хоста

1.  Отредактируйте конфиг (создается после первого запуска в `%ProgramData%\P2PRD\config.json`) или используйте `Configurator`.
    Установите URL сигнального сервера: `ws://localhost:5000/ws`.
2.  Запустите хост **как консольное приложение** (чтобы был доступ к экрану):

```bash
dotnet run --project src/Service
```

*В логах консоли вы увидите `Host ID` (GUID), который понадобится для подключения.*

### Шаг 3: Запуск Оператора (графический интерфейс)

Запустите WPF приложение Operator Console:

```bash
dotnet run --project src/OperatorConsole
```

Или соберите его и запустите исполняемый файл.

После запуска откроется окно. Введите:
- URL сигнального сервера (например, `ws://localhost:5000/ws`)
- Host ID (GUID из логов хоста)
- Пароль (если задан)

Нажмите кнопку "Connect". После установления соединения вы увидите рабочий стол удаленного компьютера и сможете управлять им с помощью мыши и клавиатуры.

## Структура проекта

  - `src/Shared` — Общие контракты, модели сообщений, конфигурации, хеширование паролей.
  - `src/Service` — Основная логика хоста: захват экрана, WebRTC, управление вводом.
  - `src/SignalingServer` — WebSocket сервер для согласования соединений.
  - `src/OperatorConsole` — Графическое клиентское приложение (WPF) для подключения оператора.
  - `src/Configurator` — Утилита настройки (WPF) для управления хостом через IPC.

## Текущий статус реализации

### Работает:

  - [x] **WebRTC Transport:** Установка P2P соединения через STUN/TURN.
  - [x] **Signaling:** Обмен сообщениями через WebSocket сервер.
  - [x] **Захват экрана:** DXGI Desktop Duplication (с автоматическим переключением на GDI при ошибках).
  - [x] **Передача видео:** Кадры передаются как PNG через Data Channel (надежно, работает везде, но низкий FPS).
  - [x] **Ввод:** Дистанционное управление мышью и клавиатурой.
  - [x] **Ctrl+Alt+Del:** Реализовано через `SendSAS` с безопасной обработкой отсутствия DLL.
  - [x] **Конфигуратор:** Настройка пароля и ICE-серверов через GUI (права доступа к IPC исправлены для локальных пользователей).
  - [x] **GUI Клиент:** Графическое приложение для оператора (WPF), обеспечивающее просмотр рабочего стола и управление вводом.

### Требует доработки (План развития):

  - [ ] **Видео-кодек:** Внедрение полноценного VP8/H.264 потока через RTP (Media Stream Track) вместо отправки картинок.
  - [ ] **Режим Службы:** Адаптация архитектуры для работы в режиме Windows Service (разделение на системный процесс и пользовательский агент для доступа к GUI).
  - [ ] **Звук:** Захват и передача аудиопотока.
  - [ ] **Безопасность:** Шифрование конфигурационных файлов, защита от брутфорса на уровне сигнального сервера.

## Сборка релизной версии

Используйте скрипты в папке `scripts/` для создания самодостаточных (self-contained) exe-файлов.

Powershell (Windows):

```powershell
./scripts/publish.ps1 -Runtime win-x64
```

Артефакты появятся в папке `artifacts/win-x64/`.
